{{/* 1. Get the publications section */}}
{{ $section := site.GetPage "section" "publications" }}

{{ if $section }}
<section id="publications" class="section-publications py-5">
    <div class="container">
        
        {{/* Header Section */}}
        <div class="row">
            <div class="col-lg-12 text-center">
                <h2 class="section-heading text-uppercase">{{ $section.Title }}</h2>
                {{ if $section.Params.subtitle }}
                <h3 class="section-subheading text-muted">{{ $section.Params.subtitle }}</h3>
                {{ end }}
            </div>
        </div>
        
        {{/* 2. Logic to Split Papers */}}
        {{/* Get all pages sorted by date */}}
        {{ $all_pages := $section.RegularPages.ByDate.Reverse }}

        {{/* Filter Preprints: Look for "3" in publication_types */}}
        {{ $preprints := where $all_pages "Params.publication_types" "intersect" (slice "preprint") }}
        
        {{/* Filter Published: Everything that is NOT a preprint */}}
        {{ $published := $all_pages | complement $preprints }}

        <div class="row">
            <div class="col-lg-12">
                <div class="publication-list">
                    
                    {{/* 3. Render Preprints (if any exist) */}}
                    {{ if gt (len $preprints) 0 }}
                    <h3 class="mt-5 mb-4 text-muted border-bottom pb-2">Preprints</h3>
                    {{ range $preprints }}
                        {{ template "publication-item" . }}
                    {{ end }}
                    {{ end }}

                    {{/* 4. Render Published Articles */}}
                    {{ if gt (len $published) 0 }}
                    <h3 class="mt-5 mb-4 text-muted border-bottom pb-2">Published Articles</h3>
                    {{ range $published }}
                        {{ template "publication-item" . }}
                    {{ end }}
                    {{ end }}

                </div>
            </div>
        </div>
    </div>
</section>

{{ end }} {{/* End of the main IF block */}}


{{/* --------------------------------------------------------- */}}
{{/* 5. Reusable Template (MOVED OUTSIDE THE IF BLOCK)         */}}
{{/* --------------------------------------------------------- */}}

{{ define "publication-item" }}
    {{/* Generate Unique ID */}}
    {{ $abstractID := printf "abstract-%s" .File.UniqueID }}
    
    <div class="mb-5">
            <span class="mb-2" style="font-size: 1.5rem">{{ .Title }}</span>

            <span class="text-muted mb-2 text-uppercase" style="font-weight: 600; color: #333;">
                {{ delimit .Params.authors ", " }}
            </span>
            <!-- <br> -->
            
            {{ if .Params.publication }}
                <span>{{ .Params.publication | markdownify }}</span>
            {{ end }}
            
            <span>({{ .Date.Format "2006" }})</span>.

        <div class="publication-links">
            {{/* Abstract Button */}}
            {{ if or .Params.abstract .Summary }}
            <button class="btn btn-sm btn-outline-primary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#{{ $abstractID }}" aria-expanded="false" aria-controls="{{ $abstractID }}">
                Abstract
            </button>
            {{ end }}

            {{/* Links */}}
            {{ range .Params.links }}
                <a href="{{ .url }}" class="btn btn-sm btn-outline-dark me-2" target="_blank">{{ .name }}</a>
            {{ end }}

            {{/* DOI */}}
            {{ if .Params.doi }}
                <a href="https://doi.org/{{ .Params.doi }}" class="btn btn-sm btn-outline-dark me-2" target="_blank">DOI</a>
            {{ end }}

            {{/* PDF */}}
            {{ if .Params.url_pdf }}
                <a href="{{ .Params.url_pdf }}" class="btn btn-sm btn-outline-dark me-2" target="_blank">PDF</a>
            {{ end }}
        </div>

        {{/* Collapsible Abstract */}}
        {{ if or .Params.abstract .Summary }}
        <div class="collapse mt-3" id="{{ $abstractID }}">
            <div class="card card-body text-muted bg-light border-0">
                {{ if .Params.abstract }}
                    <span>{{ .Params.abstract }}</span>
                {{ else }}
                    <span>{{ .Summary }}</span>
                {{ end }}
            </div>
        </div>
        {{ end }}
        
        <hr class="mt-4">
    </div>
{{ end }}